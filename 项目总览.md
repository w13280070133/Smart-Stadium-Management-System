# 项目总览（移交说明）  

## 1. 系统整体架构概述  
- **后端**：FastAPI（Python 3.12），使用 MySQL 8（库名 `gym_v2`），直接访问数据库，无额外消息中间件。接口主要位于 `backend/app/routers/`。  
- **数据库**：核心表包含 `members`、`member_cards`、`member_transactions`、`court_reservations`、`orders`、`order_items`、`products`、`product_sales`、`course_enrollments`、`training_courses` 等，结构参考根目录 `Dump20251123.sql`。  
- **管理端**：`admin-frontend`，Vue3 + Element Plus，入口/路由在 `src/router/index.ts`，页面位于 `src/views/`（例如 Dashboard、Orders、Members 等）。  
- **会员端**：`member-frontend`，同为 Vue3 + Element Plus，主要页面在 `src/views/`（如 Reservations、Courses、MyOrders 等），接口前缀 `/member/...`。  

## 2. 业务模块概览（功能现状 / 入口 / 缺陷）  
- **场地预约**  
  - 功能：支持跨天预约、自动金额计算（单价×时长），后台/会员端均可创建；取消可生成退款订单。  
  - 主要接口：`backend/app/routers/court_reservations.py`；订单创建逻辑在 `backend/app/services/orders.py`。  
  - 前端：管理端 `src/views/CourtReservations.vue`，会员端 `member-frontend/src/views/Reservations.vue`。  
  - 缺陷：会员端订单列表可能与订单状态字段映射不完全一致（前端期望的状态码需核对）。  

- **会员管理**  
  - 功能：增删改查、余额充值/扣费、登录密码设置/重置；支持办卡（计次卡、时限卡、折扣卡）。  
  - 主要接口：`backend/app/routers/members.py`，卡管理在 `backend/app/routers/member_cards.py`。  
  - 前端：管理端 `src/views/Members.vue`（已去除等级依赖，保留卡种选择）。  
  - 缺陷：等级配置未强制使用；部分旧文案/校验在其他页面可能仍引用等级。  

- **商品售卖 / 收银**  
  - 功能：商品列表、创建销售单，支持现金/余额，自动生成订单；支持退款并回冲余额。  
  - 主要接口：`backend/app/routers/product_sales.py`，订单在 `services/orders.py`。  
  - 前端：管理端 `src/views/ProductSales.vue`。  
  - 缺陷：退款/余额回冲路径已实现，但需确认前端操作入口与权限控制覆盖所有场景。  

- **培训课程 / 学员 / 班级**  
  - 功能：课程/班级结构已初步调整，报名需关联班级；退款可生成退款订单。  
  - 主要接口：`backend/app/routers/training_enrollments.py`（报名/退款），课程/班级相关在同目录其他文件；订单类型 `course` 在 `services/orders.py`。  
  - 前端：管理端 `src/views/TrainingEnrollments.vue`，会员端 `member-frontend/src/views/Courses.vue`、`MyCourses.vue`。  
  - 缺陷：报名创建课程订单的关联和退款的原订单引用需再对齐；会员端退款接口可能缺少对应后端路由。  

- **员工与账号权限**  
  - 功能：员工账号增改查基本可用；权限粒度规划在设置中心的 `roles_config`（system settings），前端部分按钮通过 `hasAction` 做了初步过滤。  
  - 主要接口：员工在 `backend/app/routers/employees.py`（未大改），权限配置读取在 `backend/app/routers/system_settings.py`。  
  - 前端：菜单/按钮权限过滤散布在各页面（如 Orders、CourtReservations、ProductSales、TrainingEnrollments）。  
  - 缺陷：权限未完全落地到后端校验，路由过滤仍需完善。  

- **系统设置中心**  
  - 功能：读取/保存预约规则、培训规则、会员等级与卡种配置、模块开关、UI 配置、角色权限、支付/超时策略、数据清理等。  
  - 主要接口：`backend/app/routers/system_settings.py`。  
  - 前端：管理端 `src/views/SettingsCenter.vue`。  
  - 缺陷：部分配置仅前端展示/存储，尚未完全作用到所有业务流程；数据清理功能需谨慎验证。  

- **通知中心、日志中心**  
  - 功能：表结构存在（`notifications`、`operation_logs`），部分页面可查看通知/日志列表。  
  - 主要接口/页面：`backend/app/routers/notifications.py`（若存在）、日志在 `operation_logs` 相关接口；管理端对应页面在 `src/views/`（需根据路由确认）。  
  - 缺陷：业务动作通知/审计尚未全面接入各模块（预约/退款/报名等动作未统一产生日志/通知）。  

## 3. 数据流 & 典型业务流程  
- **会员预约场地（会员端）/ 后台代客预约（管理端）**  
  - 表：`court_reservations`、`orders`、`order_items`，会员余额变动在 `member_transactions`。  
  - 后端：创建/取消逻辑在 `court_reservations.py`，订单生成在 `services/orders.py` 的 `create_court_order`；取消会调用退款订单逻辑。  
  - 前端：会员端 `member-frontend/src/views/Reservations.vue`；管理端 `admin-frontend/src/views/CourtReservations.vue`。金额自动计算（时长×单价），取消支持退款。  

- **培训课程报名（课程/班级 → 学员档案）**  
  - 表：`training_courses`（或班级表）、`course_enrollments`、`orders`。  
  - 后端：`training_enrollments.py` 负责报名与退款，定价可读取折扣（会员卡/等级）；订单类型 `course` 在 `services/orders.py`。  
  - 前端：管理端 `TrainingEnrollments.vue`；会员端 `Courses.vue` 报名、`MyCourses.vue` 查看/退款。  
  - 现状：报名与订单关联需复核（原始订单引用、会员端退款接口可能缺失）。  

- **商品售卖和订单产生**  
  - 表：`products`、`product_sales`、`orders`、`order_items`，余额变动在 `member_transactions`。  
  - 后端：`product_sales.py` 创建销售单并生成 `goods` 订单；退款生成退款订单并回冲库存/余额。  
  - 前端：管理端 `ProductSales.vue`（支持现金/余额、退款）。  

- **订单中心如何统一这些订单**  
  - 表：`orders`（字段：`order_type` court/course/goods/refund、`related_id` 指向业务记录、金额、支付/退款状态）。  
  - 后端：统一入口 `backend/app/services/orders.py`（`create_court_order`/`create_course_order`/`create_product_order`/`create_refund_order`）；各业务 router 在创建/取消/退款时调用。  
  - 前端：管理端 `src/views/Orders.vue` 支持类型筛选与退款；会员端 `member-frontend/src/views/MyOrders.vue` 查看订单（状态标签需对齐后端返回字段）。  

- **系统设置中心对业务的影响点**  
  - 预约规则：每次预约时长、可预约时间范围、营业时段、取消/退款策略等（读取自 `system_settings`，在 `court_reservations.py` 中使用）。  
  - 培训规则：默认课时、班级人数、报名/退费规则（`training_enrollments.py` 可读取）。  
  - 会员/卡种：会员等级、卡种折扣、计次/时限卡定义（`system_settings.py` 提供配置，`discounts.py` 和各业务定价使用）。  
  - 订单/支付：支付方式、未支付自动关闭时间（配置项在 `system_settings`，实际生效程度需再核对）。  
  - 模块开关/UI：通过设置中心读取，前端 `SettingsCenter.vue` 展示与保存。  

## 4. Codex 最近做过的关键改动概述  
- **后端重构/新增**  
  - 重写预约/订单/折扣相关逻辑：`court_reservations.py`（创建/取消生成订单与退款，支持会员卡折扣）、`services/orders.py`（court/course/goods/refund 统一创建）、`discounts.py`（读取系统设置中的等级/卡种折扣）。  
  - 商品售卖：`product_sales.py` 支持折扣、余额支付、退款回冲。  
  - 培训报名：`training_enrollments.py` 增加价格计算与退款（仍需完善订单引用）。  
  - 会员卡与会员：新增/使用 `member_cards` 表接口 `member_cards.py`；`members.py` 重新整理新增/编辑/密码等接口，默认等级“普通会员”，卡种支持计次/时限/折扣。  
  - 系统设置中心：`system_settings.py` 扩充预约规则、培训规则、会员等级与卡种、角色配置、模块开关、数据清理接口等。  
  - 报表：`reports.py` 汇总 court/goods/course/refund 的收入/概览。  
  - 会员端订单：`member_portal.py` 扩展订单查询（含 goods/refund），但状态映射仍需对齐前端。  

- **前端管理端结构性调整**  
  - 页面重写/增强：`Layout.vue`、`Dashboard.vue`、`Orders.vue`、`CourtReservations.vue`、`TrainingEnrollments.vue`、`ProductSales.vue`、`Members.vue`（去除等级依赖、保留卡种）、`MemberCards.vue`、`SettingsCenter.vue`。  
  - 权限按钮：多页面加入 `hasAction` 判断，菜单包含会员卡等入口。  

- **前端会员端调整**  
  - 预约与课程：`Reservations.vue`、`Courses.vue`、`MyCourses.vue` 重写，文案中文化，调用后端自动计价/折扣；`MyOrders.vue` 订单过滤与标签重做（需核对后端状态字段）。  

- **数据结构/SQL**  
  - 强调使用 `Dump20251123.sql` 中表结构；新增 `member_cards` 表（在代码中使用）并在系统设置中存放卡种/等级配置。  


