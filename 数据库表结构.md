# 数据库表结构文档

根据项目代码推断的核心表结构

---

## 1. courts（场地表）

**用途**：存储健身房场地信息

```sql
CREATE TABLE courts (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '场地ID',
    name VARCHAR(100) NOT NULL COMMENT '场地名称',
    type VARCHAR(50) COMMENT '场地类型（如：羽毛球场、篮球场、瑜伽室）',
    price_per_hour DECIMAL(10,2) DEFAULT 0 COMMENT '每小时价格',
    status VARCHAR(20) DEFAULT '可用' COMMENT '状态：可用、维护、停用',
    location VARCHAR(200) COMMENT '位置描述',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='场地信息表';

-- 索引建议
CREATE INDEX idx_status ON courts(status);
CREATE INDEX idx_type ON courts(type);
```

**字段说明**：
- `id`: 主键，自增
- `name`: 场地名称，必填
- `type`: 场地类型，用于分类
- `price_per_hour`: 每小时租金，用于自动计价
- `status`: 场地状态，只能是"可用"、"维护"、"停用"三种
- `location`: 场地位置描述
- `remark`: 备注信息
- `created_at`: 创建时间，自动填充

**业务规则**：
- 删除场地前需检查是否有未完成的预约
- 状态为"维护"或"停用"时不能被预约

---

## 2. court_reservations（场地预约表）

**用途**：存储场地预约记录

```sql
CREATE TABLE court_reservations (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '预约ID',
    court_id INT NOT NULL COMMENT '场地ID',
    member_id INT COMMENT '会员ID（可为空，表示非会员预约）',
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    total_amount DECIMAL(10,2) DEFAULT 0 COMMENT '预约金额',
    status VARCHAR(20) DEFAULT '已预约' COMMENT '状态：已预约、进行中、已完成、已取消',
    source VARCHAR(50) DEFAULT '后台' COMMENT '来源：后台、会员端',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    FOREIGN KEY (court_id) REFERENCES courts(id),
    FOREIGN KEY (member_id) REFERENCES members(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='场地预约表';

-- 核心索引（用于冲突检测）
CREATE INDEX idx_court_time ON court_reservations(court_id, start_time, end_time, status);
CREATE INDEX idx_member ON court_reservations(member_id);
CREATE INDEX idx_status ON court_reservations(status);
```

**字段说明**：
- `id`: 主键，自增
- `court_id`: 关联场地表
- `member_id`: 关联会员表，可为空（非会员预约）
- `start_time`: 预约开始时间，精确到秒
- `end_time`: 预约结束时间，精确到秒
- `total_amount`: 预约金额，自动计算（时长 × 单价 × 折扣）
- `status`: 预约状态
- `source`: 预约来源（后台创建或会员端创建）
- `remark`: 备注信息
- `created_at`: 创建时间

**业务规则**：
- 冲突检测：`NOT (end_time <= new_start_time OR start_time >= new_end_time)`
- 只检查非"已取消"状态的预约
- 支持跨天预约（如 23:00 - 次日 02:00）
- 取消预约时生成退款订单

---

## 3. orders（订单表）

**用途**：统一管理所有类型的订单（场地预约、培训课程、商品销售、退款）

```sql
CREATE TABLE orders (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '订单ID',
    order_no VARCHAR(50) UNIQUE NOT NULL COMMENT '订单号（格式：GYM-C-20250123135648123）',
    order_type VARCHAR(20) NOT NULL COMMENT '订单类型：court、training、goods、refund',
    related_id INT COMMENT '关联业务ID（预约ID、报名ID、销售单ID等）',
    source VARCHAR(50) COMMENT '来源：后台、会员端、refund',
    
    member_id INT COMMENT '会员ID',
    member_name VARCHAR(100) COMMENT '会员姓名',
    
    total_amount DECIMAL(10,2) DEFAULT 0 COMMENT '订单总金额',
    pay_amount DECIMAL(10,2) DEFAULT 0 COMMENT '实付金额',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '折扣金额',
    
    currency VARCHAR(10) DEFAULT 'CNY' COMMENT '货币单位',
    pay_method VARCHAR(50) COMMENT '支付方式：会员余额、现金、微信、支付宝',
    
    status VARCHAR(20) DEFAULT 'pending' COMMENT '订单状态：pending、paid、refunded、cancelled',
    order_status VARCHAR(20) COMMENT '订单状态（兼容字段）',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    paid_at TIMESTAMP NULL COMMENT '支付时间',
    
    remark TEXT COMMENT '备注',
    
    FOREIGN KEY (member_id) REFERENCES members(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='统一订单表';

-- 索引
CREATE INDEX idx_order_no ON orders(order_no);
CREATE INDEX idx_order_type ON orders(order_type);
CREATE INDEX idx_related_id ON orders(related_id, order_type);
CREATE INDEX idx_member ON orders(member_id);
CREATE INDEX idx_status ON orders(status);
CREATE INDEX idx_created_at ON orders(created_at);
```

**字段说明**：
- `id`: 主键，自增
- `order_no`: 订单号，格式：`前缀-类型首字母-时间戳`（如 GYM-C-20250123135648123）
- `order_type`: 订单类型
  - `court`: 场地预约订单
  - `training` / `course`: 培训课程订单
  - `goods`: 商品销售订单
  - `refund`: 退款订单（金额为负）
- `related_id`: 关联的业务记录ID
  - court 类型：关联 `court_reservations.id`
  - training 类型：关联 `course_enrollments.id`
  - goods 类型：关联 `product_sales.id`
  - refund 类型：关联原订单的 `orders.id`
- `source`: 订单来源（后台、会员端、refund）
- `member_id` / `member_name`: 会员信息
- `total_amount`: 订单总金额
- `pay_amount`: 实际支付金额（退款订单为负值）
- `discount_amount`: 折扣金额
- `currency`: 货币单位（默认 CNY）
- `pay_method`: 支付方式
- `status` / `order_status`: 订单状态（两个字段兼容不同版本）
  - `pending`: 待支付
  - `paid`: 已支付
  - `refunded`: 已退款
  - `cancelled`: 已取消
- `created_at`: 创建时间
- `paid_at`: 支付时间（已支付订单才有值）
- `remark`: 备注信息

**业务规则**：
- 订单号自动生成，格式：`前缀-类型-时间戳`
- 退款订单的 `pay_amount` 和 `total_amount` 为负值
- 退款订单的 `related_id` 指向原订单 ID
- 订单状态流转：pending → paid → refunded/cancelled

---

## 4. order_items（订单明细表）

**用途**：存储商品销售订单的明细（仅用于 goods 类型订单）

```sql
CREATE TABLE order_items (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '明细ID',
    order_id INT NOT NULL COMMENT '订单ID',
    item_type VARCHAR(20) DEFAULT 'product' COMMENT '项目类型：product',
    item_id INT COMMENT '商品ID',
    item_name VARCHAR(200) COMMENT '商品名称',
    unit_price DECIMAL(10,2) DEFAULT 0 COMMENT '单价',
    quantity INT DEFAULT 1 COMMENT '数量',
    amount DECIMAL(10,2) DEFAULT 0 COMMENT '小计金额',
    
    FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='订单明细表';

-- 索引
CREATE INDEX idx_order_id ON order_items(order_id);
CREATE INDEX idx_item ON order_items(item_type, item_id);
```

**字段说明**：
- `id`: 主键，自增
- `order_id`: 关联订单表
- `item_type`: 项目类型（目前只有 product）
- `item_id`: 商品ID
- `item_name`: 商品名称（冗余存储，防止商品删除后无法查看历史）
- `unit_price`: 单价
- `quantity`: 数量
- `amount`: 小计金额（unit_price × quantity）

**业务规则**：
- 仅用于商品销售订单（order_type = 'goods'）
- 一个订单可以有多个明细
- 订单删除时级联删除明细

---

## 5. members（会员表）

**用途**：存储会员基本信息

```sql
CREATE TABLE members (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '会员ID',
    name VARCHAR(100) NOT NULL COMMENT '会员姓名',
    phone VARCHAR(20) UNIQUE COMMENT '手机号',
    password_hash VARCHAR(255) COMMENT '登录密码（加密）',
    balance DECIMAL(10,2) DEFAULT 0 COMMENT '账户余额',
    status VARCHAR(20) DEFAULT '正常' COMMENT '状态：正常、冻结、注销',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '注册时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员表';

-- 索引
CREATE UNIQUE INDEX idx_phone ON members(phone);
CREATE INDEX idx_status ON members(status);
```

---

## 6. member_cards（会员卡表）

**用途**：存储会员持有的各类卡（计次卡、时限卡、折扣卡）

```sql
CREATE TABLE member_cards (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '卡ID',
    member_id INT NOT NULL COMMENT '会员ID',
    card_type VARCHAR(20) NOT NULL COMMENT '卡类型：计次卡、时限卡、折扣卡',
    card_name VARCHAR(100) COMMENT '卡名称',
    
    -- 计次卡字段
    total_times INT COMMENT '总次数',
    remaining_times INT COMMENT '剩余次数',
    
    -- 时限卡字段
    valid_from DATE COMMENT '有效期开始',
    valid_until DATE COMMENT '有效期结束',
    
    -- 折扣卡字段
    discount DECIMAL(5,2) COMMENT '折扣率（如 85 表示 85 折）',
    
    status VARCHAR(20) DEFAULT '正常' COMMENT '状态：正常、已用完、已过期',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '办卡时间',
    
    FOREIGN KEY (member_id) REFERENCES members(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员卡表';

-- 索引
CREATE INDEX idx_member ON member_cards(member_id);
CREATE INDEX idx_status ON member_cards(status);
```

---

## 7. member_transactions（会员流水表）

**用途**：记录会员余额变动流水

```sql
CREATE TABLE member_transactions (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '流水ID',
    member_id INT NOT NULL COMMENT '会员ID',
    type VARCHAR(20) NOT NULL COMMENT '类型：充值、消费、退款',
    amount DECIMAL(10,2) NOT NULL COMMENT '金额（正数为增加，负数为减少）',
    balance_after DECIMAL(10,2) NOT NULL COMMENT '变动后余额',
    remark TEXT COMMENT '备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '交易时间',
    
    FOREIGN KEY (member_id) REFERENCES members(id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='会员流水表';

-- 索引
CREATE INDEX idx_member ON member_transactions(member_id);
CREATE INDEX idx_type ON member_transactions(type);
CREATE INDEX idx_created_at ON member_transactions(created_at);
```

---

## 8. system_settings（系统设置表）

**用途**：存储系统配置（包括角色权限配置）

```sql
CREATE TABLE system_settings (
    id INT PRIMARY KEY AUTO_INCREMENT COMMENT '设置ID',
    group_key VARCHAR(50) NOT NULL COMMENT '配置分组：permission、order、reservation等',
    setting_key VARCHAR(50) NOT NULL COMMENT '配置键',
    setting_value TEXT COMMENT '配置值（支持 JSON 格式）',
    description VARCHAR(255) COMMENT '描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    
    UNIQUE KEY uk_group_setting (group_key, setting_key)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='系统设置表';
```

**重要配置示例**：

```sql
-- 角色权限配置
INSERT INTO system_settings (group_key, setting_key, setting_value, description) VALUES
('permission', 'roles_json', '[
  {
    "code": "admin",
    "name": "管理员",
    "menus": ["*"],
    "actions": ["*"],
    "data_scope": "all"
  },
  {
    "code": "staff",
    "name": "普通员工",
    "menus": ["dashboard", "members", "orders"],
    "actions": ["view", "create", "edit-self"],
    "data_scope": "own"
  }
]', '角色权限配置');

-- 订单配置
INSERT INTO system_settings (group_key, setting_key, setting_value, description) VALUES
('order', 'order_no_prefix', 'GYM', '订单号前缀'),
('order', 'default_currency', 'CNY', '默认货币');
```

---

## 核心表关系图

```
members (会员)
  ├─→ member_cards (会员卡)
  ├─→ member_transactions (流水)
  ├─→ court_reservations (预约)
  └─→ orders (订单)

courts (场地)
  └─→ court_reservations (预约)

court_reservations (预约)
  └─→ orders (订单) [order_type='court']

orders (订单)
  └─→ order_items (订单明细) [仅 goods 类型]
```

---

## 索引优化建议

### 1. 冲突检测性能优化
```sql
-- 场地预约冲突检测的核心索引
CREATE INDEX idx_court_time_status 
ON court_reservations(court_id, start_time, end_time, status);
```

### 2. 订单查询优化
```sql
-- 按订单类型和关联ID查询
CREATE INDEX idx_order_type_related 
ON orders(order_type, related_id);

-- 按会员查询订单
CREATE INDEX idx_member_created 
ON orders(member_id, created_at DESC);
```

### 3. 会员流水查询优化
```sql
-- 按会员和时间查询流水
CREATE INDEX idx_member_time 
ON member_transactions(member_id, created_at DESC);
```

---

## 数据完整性约束

1. **外键约束**：确保数据一致性
2. **唯一约束**：订单号、会员手机号等
3. **检查约束**：状态字段只能是预定义的值
4. **非空约束**：关键字段不能为空

---

## 备注

- 本文档基于项目代码推断，实际表结构可能略有差异
- 建议参考项目根目录的 `Dump20251123.sql` 文件获取完整表结构
- 表结构设计遵循第三范式，适度冗余以提升查询性能
